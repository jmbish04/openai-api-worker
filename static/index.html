<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI-Compatible API Worker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .badge {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .badge.streaming {
            background: #2196F3;
        }

        .badge.multimodal {
            background: #FF9800;
        }

        .badge.cors {
            background: #9C27B0;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
        }

        .nav-item:hover {
            background: #f5f5f5;
        }

        .nav-item.active {
            border-bottom-color: #667eea;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .section h3 {
            color: #555;
            margin: 30px 0 15px 0;
            font-size: 1.3rem;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .copy-btn:hover {
            background: #5a67d8;
        }

        .api-tester {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .response-area {
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: white;
            margin: 20px 0;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .message.user {
            background: #e3f2fd;
            margin-left: 20px;
        }

        .message.assistant {
            background: #f1f8e9;
            margin-right: 20px;
        }

        .message .role {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .message.user .role {
            color: #1976d2;
        }

        .message.assistant .role {
            color: #388e3c;
        }

        .endpoint-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .endpoint-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .endpoint-card.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .endpoint-method {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .endpoint-method.post {
            background: #007bff;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .nav {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🚀 OpenAI API Worker</h1>
            <p>Cloudflare-powered AI with OpenAI compatibility</p>
            <div class="badges">
                <span class="badge">OpenAI Compatible</span>
                <span class="badge streaming">Streaming</span>
                <span class="badge multimodal">Multimodal</span>
                <span class="badge cors">CORS Ready</span>
            </div>
        </div>

        <div class="content">
            <div class="nav">
                <div class="nav-item active" onclick="showSection('overview')">📖 Overview</div>
                <div class="nav-item" onclick="showSection('tester')">🧪 API Tester</div>
                <div class="nav-item" onclick="showSection('chat')">💬 Chat Interface</div>
                <div class="nav-item" onclick="showSection('endpoints')">🔗 Endpoints</div>
                <div class="nav-item" onclick="showSection('examples')">💡 Examples</div>
                <div class="nav-item" onclick="showSection('auth')">🔐 Authentication</div>
            </div>

            <div id="overview" class="section active">
                <h2>🌟 Welcome to OpenAI API Worker</h2>
                <p>This Cloudflare Worker provides a fully OpenAI-compatible API interface powered by Cloudflare's AI
                    models. Get the performance of edge computing with the familiarity of OpenAI's API.</p>

                <h3>✨ Key Features</h3>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>OpenAI Compatible:</strong> Drop-in replacement for OpenAI API</li>
                    <li><strong>Edge Performance:</strong> Powered by Cloudflare's global network</li>
                    <li><strong>Multimodal Support:</strong> Text generation and image recognition</li>
                    <li><strong>Streaming Responses:</strong> Real-time response streaming</li>
                    <li><strong>Multiple Models:</strong> Primary and backup model support</li>
                    <li><strong>CORS Enabled:</strong> Ready for web applications</li>
                </ul>

                <h3>🚀 Quick Start</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    <pre><code id="curl-example">curl -X POST [WORKER_URL]/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_WORKER_API_KEY" \
  -d '{
    "model": "gpt-4",
    "messages": [
      {"role": "user", "content": "Hello!"}
    ]
  }'
</code></pre>
                </div>

                <h3>📚 Resources</h3>
                <p>
                    • <a href="/openapi.json" target="_blank">OpenAPI Specification</a><br>
                    • <a href="/health" target="_blank">Health Check</a><br>
                    • <a href="https://docs.cloudflare.com/workers/">Cloudflare Workers Docs</a>
                </p>
            </div>

            <div id="tester" class="section">
                <h2>🧪 API Endpoint Tester</h2>
                <p>Test all API endpoints with your worker API key.</p>

                <div class="api-tester">
                    <h3>🔑 API Configuration</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="global-api-key">Worker API Key:</label>
                            <input type="password" id="global-api-key" placeholder="Enter your worker API key">
                        </div>
                        <div class="form-group">
                            <label>Connection Status:</label>
                            <div>
                                <span id="connection-status" class="status-indicator disconnected"></span>
                                <span id="connection-text">Not Connected</span>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="ai-service">AI Service:</label>
                            <select id="ai-service" onchange="onAIServiceChange()">
                                <option value="cloudflare">Cloudflare (edge)</option>
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Gemini</option>
                            </select>
                        </div>

                        <div id="openai-controls" class="form-group" style="display:none">
                            <label for="openai-model-select">OpenAI Model:</label>
                            <select id="openai-model-select"></select>
                        </div>

                        <div id="gemini-controls" class="form-group" style="display:none">
                            <label for="gemini-model-select">Gemini Model:</label>
                            <select id="gemini-model-select"></select>
                        </div>

                        <div id="cloudflare-controls" class="form-group full-width">
                            <label for="cloudflare-provider-select">Cloudflare Provider:</label>
                            <select id="cloudflare-provider-select" onchange="onCloudflareProviderChange()"></select>
                        </div>

                        <div id="cloudflare-model-controls" class="form-group full-width">
                            <label for="cloudflare-model-select">Cloudflare Model:</label>
                            <select id="cloudflare-model-select"></select>
                        </div>
                    </div>
                    <button class="btn" onclick="testConnection()">Test Connection</button>
                    <button class="btn secondary" onclick="clearApiKey()">Clear Key</button>
                </div>

                <div class="api-tester">
                    <h3>📋 Available Endpoints</h3>

                    <div class="endpoint-card" onclick="selectEndpoint('models')">
                        <div class="endpoint-method">GET</div>
                        <h4>/v1/models</h4>
                        <p>List all available AI models</p>
                    </div>

                    <div class="endpoint-card" onclick="selectEndpoint('chat')">
                        <div class="endpoint-method post">POST</div>
                        <h4>/v1/chat/completions</h4>
                        <p>Create chat completions (streaming & non-streaming)</p>
                    </div>

                    <div class="endpoint-card" onclick="selectEndpoint('completions')">
                        <div class="endpoint-method post">POST</div>
                        <h4>/v1/completions</h4>
                        <p>Legacy text completion endpoint</p>
                    </div>
                </div>

                <div id="endpoint-tester" style="display: none;">
                    <div class="api-tester">
                        <h3 id="endpoint-title">Test Endpoint</h3>
                        <div id="endpoint-form"></div>
                        <div class="response-area" id="endpoint-response"></div>
                    </div>
                </div>
            </div>

            <div id="chat" class="section">
                <h2>💬 Interactive Chat Interface</h2>
                <p>Chat with the AI using your worker API key.</p>

                <div class="api-tester">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="chat-api-key">Worker API Key:</label>
                            <input type="password" id="chat-api-key" placeholder="Enter your worker API key"
                                onchange="onChatApiKeyChange()">
                        </div>
                        <div class="form-group">
                            <label for="chat-model">Model:</label>
                            <select id="chat-model">
                                <option value="gpt-4">GPT-4 (Recommended)</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                            </select>
                        </div>
                    </div>

                    <div class="chat-container" id="chat-messages">
                        <div class="message assistant">
                            <div class="role">Assistant</div>
                            <div>Hello! I'm ready to help. Enter your API key above and start chatting!</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="chat-input">Your Message:</label>
                        <textarea id="chat-input" placeholder="Type your message here..."
                            onkeypress="handleChatKeyPress(event)"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn" onclick="sendChatMessage()" id="send-btn">Send Message</button>
                        <label style="display: flex; align-items: center; gap: 5px; margin: 0;">
                            <input type="checkbox" id="stream-chat"> Enable Streaming
                        </label>
                        <button class="btn secondary" onclick="clearChat()">Clear Chat</button>
                    </div>
                </div>
            </div>

            <div id="endpoints" class="section">
                <h2>🔗 API Endpoints</h2>

                <h3>Public Endpoints (No Authentication)</h3>
                <div class="endpoint-card">
                    <div class="endpoint-method">GET</div>
                    <h4>/</h4>
                    <p>This interactive documentation page</p>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-method">GET</div>
                    <h4>/openapi.json</h4>
                    <p>Complete OpenAPI 3.0 specification</p>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-method">GET</div>
                    <h4>/health</h4>
                    <p>Service health status check</p>
                </div>

                <h3>API Endpoints (Require Authentication)</h3>
                <div class="endpoint-card">
                    <div class="endpoint-method post">POST</div>
                    <h4>/v1/chat/completions</h4>
                    <p>Create chat completions with support for streaming and multimodal inputs</p>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-method">GET</div>
                    <h4>/v1/models</h4>
                    <p>List all available models and their capabilities</p>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-method post">POST</div>
                    <h4>/v1/completions</h4>
                    <p>Legacy completion endpoint for simple text generation</p>
                </div>
            </div>

            <div id="examples" class="section">
                <h2>💡 Code Examples</h2>

                <h3>JavaScript / Node.js</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    <pre><code class="language-javascript">const response = await fetch('[WORKER_URL]/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_WORKER_API_KEY'
  },
  body: JSON.stringify({
    model: 'gpt-4',
    messages: [
      {
        role: 'user',
        content: 'Explain quantum computing'
      }
    ],
    max_tokens: 500,
    temperature: 0.7
  })
});

const data = await response.json();
console.log(data.choices[0].message.content);
</code></pre>
                </div>

                <h3>Python</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    <pre><code class="language-python">import requests

response = requests.post(
    '[WORKER_URL]/v1/chat/completions',
    headers={
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_WORKER_API_KEY'
    },
    json={
        'model': 'gpt-4',
        'messages': [
            {
                'role': 'user',
                'content': 'Explain quantum computing'
            }
        ],
        'max_tokens': 500,
        'temperature': 0.7
    }
)

print(response.json()['choices'][0]['message']['content'])
</code></pre>
                </div>

                <h3>cURL</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    <pre><code class="language-shell">curl -X POST [WORKER_URL]/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_WORKER_API_KEY" \
  -d '{
    "model": "gpt-4",
    "messages": [
      {"role": "user", "content": "Hello!"}
    ],
    "max_tokens": 100
  }'
</code></pre>
                </div>
            </div>

            <div id="auth" class="section">
                <h2>🔐 Authentication</h2>

                <p>This API uses Bearer token authentication. Include your worker API key in the Authorization header:
                </p>

                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    Authorization: Bearer YOUR_WORKER_API_KEY
                </div>

                <h3>Setting Up Your Worker API Key</h3>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>Choose a secure API key for your worker (e.g., <code>sk-myworker-abc123...</code>)</li>
                    <li>Store the key securely (never expose in client-side code)</li>
                    <li>Set it in production using <code>wrangler secret put WORKER_API_KEY</code></li>
                    <li>Users will include this key in all API requests to your worker</li>
                </ol>

                <div class="alert error">
                    <strong>⚠️ Security Warning:</strong> Never expose your worker API key in client-side JavaScript or
                    public repositories. Always use environment variables or secure key management systems.
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEndpoint = null;
        let chatHistory = [];
        let availableModels = [];

        // Load available models on page load
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                const currentOrigin = location.origin;

                // Replace placeholder in code blocks
                document.querySelectorAll('.worker-url-placeholder').forEach(el => {
                    el.textContent = currentOrigin;
                });

                // Update standalone curl/example block
                const curlExample = document.getElementById('curl-example');
                if (curlExample) {
                    curlExample.textContent = curlExample.textContent.replace(/\[WORKER_URL\]/g, currentOrigin);
                }

                // Replace placeholders inside code samples
                document.querySelectorAll('.code-block code').forEach(codeEl => {
                    codeEl.textContent = codeEl.textContent.replace(/\[WORKER_URL\]/g, currentOrigin);
                });

                // Load models in background (without requiring API key for UI setup)
                await loadAvailableModels();
            } catch (error) {
                console.log('Could not update worker URL or load models:', error);
            }
        });

        async function loadAvailableModels() {
            try {
                const response = await fetch('/v1/models');
                if (response.status === 401) {
                    // Endpoint exists but requires auth
                    console.log('Models endpoint available, auth required');
                    return;
                }

                if (response.ok) {
                    const data = await response.json();
                    availableModels = data.data || [];
                    updateModelSelectors();
                }
            } catch (error) {
                console.log('Models endpoint not available yet:', error);
            }
        }

        async function loadModelsWithAuth(apiKey) {
            if (!apiKey) return;

            try {
                const response = await fetch('/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    availableModels = data.data || [];
                    updateModelSelectors();

                    // Show models info in UI
                    showModelsInfo(data);
                } else {
                    console.log('Models request failed with status', response.status);
                }
            } catch (error) {
                console.log('Error loading models:', error);
            }
        }

        function updateModelSelectors() {
            const selectors = ['chat-model', 'test-model', 'completion-model'];

            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    const currentValue = selector.value;
                    selector.innerHTML = '';

                    // Add a default option
                    const defaultOpt = document.createElement('option');
                    defaultOpt.value = '';
                    defaultOpt.textContent = 'Select model...';
                    selector.appendChild(defaultOpt);

                    availableModels.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.textContent = m.id;
                        selector.appendChild(opt);
                    });

                    if (currentValue) {
                        try { selector.value = currentValue; } catch (e) { }
                    }
                }
            });

            // New: populate service-specific selectors
            const openaiSelect = document.getElementById('openai-model-select');
            const geminiSelect = document.getElementById('gemini-model-select');
            const cfProviderSelect = document.getElementById('cloudflare-provider-select');
            const cfModelSelect = document.getElementById('cloudflare-model-select');

            // Derive lists
            const openaiModels = availableModels.filter(m => (m.owned_by || '').toLowerCase().includes('openai'));
            const geminiModels = availableModels.filter(m => (m.owned_by || '').toLowerCase().includes('gemini'));
            const cloudModels = availableModels.filter(m => {
                const owned = (m.owned_by || '').toLowerCase();
                return owned.includes('cloudflare') || (m.id && m.id.startsWith('@cf/')) || owned.includes('cloudflare-proxy');
            });

            // Populate OpenAI models
            if (openaiSelect) {
                openaiSelect.innerHTML = '';
                const d = document.createElement('option'); d.value = ''; d.textContent = 'Select OpenAI model...'; openaiSelect.appendChild(d);
                openaiModels.forEach(m => {
                    const o = document.createElement('option'); o.value = m.id; o.textContent = m.id; openaiSelect.appendChild(o);
                });
            }

            // Populate Gemini models
            if (geminiSelect) {
                geminiSelect.innerHTML = '';
                const d = document.createElement('option'); d.value = ''; d.textContent = 'Select Gemini model...'; geminiSelect.appendChild(d);
                geminiModels.forEach(m => {
                    const o = document.createElement('option'); o.value = m.id; o.textContent = m.id; geminiSelect.appendChild(o);
                });
            }

            // Derive providers from cloudModels (look for '@cf/<provider>/...')
            const providers = [];
            const providerMap = {};
            cloudModels.forEach(m => {
                let providerKey = 'compatibility';
                if (m.id && m.id.startsWith('@cf/')) {
                    const parts = m.id.split('/');
                    providerKey = parts[1] || providerKey;
                } else if (m.root && m.root.startsWith('@cf/')) {
                    const parts = m.root.split('/');
                    providerKey = parts[1] || providerKey;
                } else if (m.owned_by) {
                    providerKey = m.owned_by;
                }

                if (!providers.includes(providerKey)) providers.push(providerKey);
                providerMap[providerKey] = providerMap[providerKey] || [];
                providerMap[providerKey].push(m);
            });

            if (cfProviderSelect) {
                cfProviderSelect.innerHTML = '';
                const d = document.createElement('option'); d.value = ''; d.textContent = 'Select provider...'; cfProviderSelect.appendChild(d);
                providers.forEach(p => {
                    const o = document.createElement('option'); o.value = p; o.textContent = p; cfProviderSelect.appendChild(o);
                });
            }

            // Populate cloudflare model select based on currently selected provider
            function populateCfModelsForProvider(selectedProvider) {
                if (!cfModelSelect) return;
                cfModelSelect.innerHTML = '';
                const d = document.createElement('option'); d.value = ''; d.textContent = 'Select Cloudflare model...'; cfModelSelect.appendChild(d);
                if (!selectedProvider) return;
                const list = providerMap[selectedProvider] || [];
                list.forEach(m => {
                    const o = document.createElement('option'); o.value = m.id; o.textContent = m.id; cfModelSelect.appendChild(o);
                });
            }

            const selectedProvider = (cfProviderSelect && cfProviderSelect.value) || null;
            populateCfModelsForProvider(selectedProvider);
        }

        function showModelsInfo(data) {
            const modelCount = data.data ? data.data.length : 0;
            const coreApiModels = data.data ? data.data.filter(m => (m.owned_by || '').toLowerCase().includes('cloudflare')).length : 0;

            // Update connection status area with models info
            const statusArea = document.querySelector('#tester .api-tester:first-child');
            if (statusArea) {
                let modelsInfo = document.getElementById('models-info');
                if (!modelsInfo) {
                    modelsInfo = document.createElement('div');
                    modelsInfo.id = 'models-info';
                    statusArea.appendChild(modelsInfo);
                }

                modelsInfo.innerHTML = `<div class="alert info">Detected ${modelCount} model(s) available${coreApiModels ? ` — ${coreApiModels} owned by Cloudflare` : ''}.</div>`;

                // Add a short list of first 10 models
                const list = document.createElement('div');
                list.className = 'json-viewer';
                list.textContent = (data.data || []).slice(0, 10).map(m => `${m.id} — ${m.description || ''}`).join('\n');

                // Replace existing list if present
                const existingList = document.getElementById('models-list');
                if (existingList) existingList.remove();
                list.id = 'models-list';
                statusArea.appendChild(list);
            }
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            const target = document.getElementById(sectionId);
            if (target) target.classList.add('active');

            // Mark nav item active by matching onclick content
            const clickedNav = Array.from(document.querySelectorAll('.nav-item')).find(item => {
                const attr = item.getAttribute('onclick') || '';
                return attr.includes(`'${sectionId}'`) || attr.includes(`"${sectionId}"`);
            });
            if (clickedNav) clickedNav.classList.add('active');
        }

        function copyToClipboard(button) {
            try {
                const codeBlock = button.parentElement;
                const codeEl = codeBlock.querySelector('code');
                if (!codeEl) return;
                const text = codeEl.textContent;

                navigator.clipboard.writeText(text).then(() => {
                    const original = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => { button.textContent = original; }, 2000);
                }).catch(err => {
                    console.error('Copy failed', err);
                });
            } catch (e) {
                console.error('copyToClipboard error', e);
            }
        }

        async function testConnection() {
            const apiKey = document.getElementById('global-api-key').value;
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');

            // Optimistically show loading
            statusIndicator.className = 'status-indicator';
            statusText.textContent = 'Checking...';

            try {
                const headers = {};
                if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;

                const resp = await fetch('/v1/models', { headers });

                if (resp.ok) {
                    const data = await resp.json();
                    statusIndicator.className = 'status-indicator connected';
                    statusText.textContent = `Connected — ${data.data ? data.data.length : 0} model(s)`;
                    availableModels = data.data || [];
                    updateModelSelectors();
                    showModelsInfo(data);
                } else if (resp.status === 401) {
                    statusIndicator.className = 'status-indicator disconnected';
                    statusText.textContent = 'Auth required — endpoint available';
                } else {
                    statusIndicator.className = 'status-indicator disconnected';
                    statusText.textContent = `Error: ${resp.status}`;
                }
            } catch (err) {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Connection failed';
                console.error('testConnection error', err);
            }
        }

        function clearApiKey() {
            const el = document.getElementById('global-api-key');
            if (el) el.value = '';
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            statusIndicator.className = 'status-indicator disconnected';
            statusText.textContent = 'Not Connected';
        }

        async function onChatApiKeyChange() {
            const key = document.getElementById('chat-api-key').value;
            if (!key) return;
            await loadModelsWithAuth(key);
        }

        function onAIServiceChange() {
            const svc = document.getElementById('ai-service').value;
            document.getElementById('openai-controls').style.display = svc === 'openai' ? 'block' : 'none';
            document.getElementById('gemini-controls').style.display = svc === 'gemini' ? 'block' : 'none';
            document.getElementById('cloudflare-controls').style.display = svc === 'cloudflare' ? 'block' : 'none';
            document.getElementById('cloudflare-model-controls').style.display = svc === 'cloudflare' ? 'block' : 'none';
        }

        function onCloudflareProviderChange() {
            const provider = document.getElementById('cloudflare-provider-select').value;
            const cfModelSelect = document.getElementById('cloudflare-model-select');
            if (!cfModelSelect) return;

            // Rebuild provider map from availableModels (same logic as updateModelSelectors)
            const cloudModels = availableModels.filter(m => {
                const owned = (m.owned_by || '').toLowerCase();
                return owned.includes('cloudflare') || (m.id && m.id.startsWith('@cf/')) || owned.includes('cloudflare-proxy');
            });

            const list = cloudModels.filter(m => {
                if (m.id && m.id.startsWith('@cf/')) {
                    const parts = m.id.split('/');
                    return parts[1] === provider;
                }
                if (m.root && m.root.startsWith('@cf/')) {
                    const parts = m.root.split('/');
                    return parts[1] === provider;
                }
                return (m.owned_by || '') === provider;
            });

            cfModelSelect.innerHTML = '';
            const d = document.createElement('option'); d.value = ''; d.textContent = 'Select Cloudflare model...'; cfModelSelect.appendChild(d);
            list.forEach(m => {
                const o = document.createElement('option'); o.value = m.id; o.textContent = m.id; cfModelSelect.appendChild(o);
            });
        }
    </script>
</body>

</html>