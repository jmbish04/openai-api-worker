<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAI-Compatible API Worker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .badge {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .badge.streaming { background: #2196F3; }
        .badge.multimodal { background: #FF9800; }
        .badge.cors { background: #9C27B0; }

        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 600;
            border-radius: 8px 8px 0 0;
        }

        .nav-item:hover {
            background: #f5f5f5;
        }

        .nav-item.active {
            border-bottom-color: #667eea;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .section h3 {
            color: #555;
            margin: 30px 0 15px 0;
            font-size: 1.3rem;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .copy-btn:hover {
            background: #5a67d8;
        }

        .api-tester {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            background: #5a6268;
        }

        .response-area {
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .chat-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: white;
            margin: 20px 0;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .message.user {
            background: #e3f2fd;
            margin-left: 20px;
        }

        .message.assistant {
            background: #f1f8e9;
            margin-right: 20px;
        }

        .message .role {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .message.user .role {
            color: #1976d2;
        }

        .message.assistant .role {
            color: #388e3c;
        }

        .endpoint-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .endpoint-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .endpoint-card.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .endpoint-method {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .endpoint-method.post {
            background: #007bff;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .status-indicator.disconnected {
            background: #dc3545;
        }

        .json-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .nav {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 OpenAI API Worker</h1>
            <p>Cloudflare-powered AI with OpenAI compatibility</p>
            <div class="badges">
                <span class="badge">OpenAI Compatible</span>
                <span class="badge streaming">Streaming</span>
                <span class="badge multimodal">Multimodal</span>
                <span class="badge cors">CORS Ready</span>
            </div>
        </div>

        <div class="content">
            <div class="nav">
                <div class="nav-item active" onclick="showSection('overview')">📖 Overview</div>
                <div class="nav-item" onclick="showSection('tester')">🧪 API Tester</div>
                <div class="nav-item" onclick="showSection('chat')">💬 Chat Interface</div>
                <div class="nav-item" onclick="showSection('endpoints')">🔗 Endpoints</div>
                <div class="nav-item" onclick="showSection('examples')">💡 Examples</div>
                <div class="nav-item" onclick="showSection('auth')">🔐 Authentication</div>
            </div>

            <div id="overview" class="section active">
                <h2>🌟 Welcome to OpenAI API Worker</h2>
                <p>This Cloudflare Worker provides a fully OpenAI-compatible API interface powered by Cloudflare's AI models. Get the performance of edge computing with the familiarity of OpenAI's API.</p>

                <h3>✨ Key Features</h3>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>OpenAI Compatible:</strong> Drop-in replacement for OpenAI API</li>
                    <li><strong>Edge Performance:</strong> Powered by Cloudflare's global network</li>
                    <li><strong>Multimodal Support:</strong> Text generation and image recognition</li>
                    <li><strong>Streaming Responses:</strong> Real-time response streaming</li>
                    <li><strong>Multiple Models:</strong> Primary and backup model support</li>
                    <li><strong>CORS Enabled:</strong> Ready for web applications</li>
                </ul>

                <h3>🚀 Quick Start</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
<span id="curl-example">curl -X POST [WORKER_URL]/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_WORKER_API_KEY" \
  -d '{
    "model": "gpt-4",
    "messages": [
      {"role": "user", "content": "Hello!"}
    ]
  }'</span>
                </div>

                <h3>📚 Resources</h3>
                <p>
                    • <a href="/openapi.json" target="_blank">OpenAPI Specification</a><br>
                    • <a href="/health" target="_blank">Health Check</a><br>
                    • <a href="https://docs.cloudflare.com/workers/">Cloudflare Workers Docs</a>
                </p>
            </div>

            <div id="tester" class="section">
                <h2>🧪 API Endpoint Tester</h2>
                <p>Test all API endpoints with your worker API key.</p>

                <div class="api-tester">
                    <h3>🔑 API Configuration</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="global-api-key">Worker API Key:</label>
                            <input type="password" id="global-api-key" placeholder="Enter your worker API key">
                        </div>
                        <div class="form-group">
                            <label>Connection Status:</label>
                            <div>
                                <span id="connection-status" class="status-indicator disconnected"></span>
                                <span id="connection-text">Not Connected</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn" onclick="testConnection()">Test Connection</button>
                    <button class="btn secondary" onclick="clearApiKey()">Clear Key</button>
                </div>

                <div class="api-tester">
                    <h3>📋 Available Endpoints</h3>
                    
                    <div class="endpoint-card" onclick="selectEndpoint('models')">
                        <div class="endpoint-method">GET</div>
                        <h4>/v1/models</h4>
                        <p>List all available AI models</p>
                    </div>

                    <div class="endpoint-card" onclick="selectEndpoint('chat')">
                        <div class="endpoint-method post">POST</div>
                        <h4>/v1/chat/completions</h4>
                        <p>Create chat completions (streaming & non-streaming)</p>
                    </div>

                    <div class="endpoint-card" onclick="selectEndpoint('completions')">
                        <div class="endpoint-method post">POST</div>
                        <h4>/v1/completions</h4>
                        <p>Legacy text completion endpoint</p>
                    </div>
                </div>

                <div id="endpoint-tester" style="display: none;">
                    <div class="api-tester">
                        <h3 id="endpoint-title">Test Endpoint</h3>
                        <div id="endpoint-form"></div>
                        <div class="response-area" id="endpoint-response"></div>
                    </div>
                </div>
            </div>

            <div id="chat" class="section">
                <h2>💬 Interactive Chat Interface</h2>
                <p>Chat with the AI using your worker API key.</p>

                <div class="api-tester">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="chat-api-key">Worker API Key:</label>
                            <input type="password" id="chat-api-key" placeholder="Enter your worker API key" onchange="onChatApiKeyChange()">
                        </div>
                        <div class="form-group">
                            <label for="chat-model">Model:</label>
                            <select id="chat-model">
                                <option value="gpt-4">GPT-4 (Recommended)</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="chat-container" id="chat-messages">
                        <div class="message assistant">
                            <div class="role">Assistant</div>
                            <div>Hello! I'm ready to help. Enter your API key above and start chatting!</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="chat-input">Your Message:</label>
                        <textarea id="chat-input" placeholder="Type your message here..." onkeypress="handleChatKeyPress(event)"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn" onclick="sendChatMessage()" id="send-btn">Send Message</button>
                        <label style="display: flex; align-items: center; gap: 5px; margin: 0;">
                            <input type="checkbox" id="stream-chat"> Enable Streaming
                        </label>
                        <button class="btn secondary" onclick="clearChat()">Clear Chat</button>
                    </div>
                </div>
            </div>

            <div id="endpoints" class="section">
                <h2>🔗 API Endpoints</h2>
                
                <h3>Public Endpoints (No Authentication)</h3>
                <div class="endpoint-card">
                    <div class="endpoint-method">GET</div>
                    <h4>/</h4>
                    <p>This interactive documentation page</p>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-method">GET</div>
                    <h4>/openapi.json</h4>
                    <p>Complete OpenAPI 3.0 specification</p>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-method">GET</div>
                    <h4>/health</h4>
                    <p>Service health status check</p>
                </div>

                <h3>API Endpoints (Require Authentication)</h3>
                <div class="endpoint-card">
                    <div class="endpoint-method post">POST</div>
                    <h4>/v1/chat/completions</h4>
                    <p>Create chat completions with support for streaming and multimodal inputs</p>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-method">GET</div>
                    <h4>/v1/models</h4>
                    <p>List all available models and their capabilities</p>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-method post">POST</div>
                    <h4>/v1/completions</h4>
                    <p>Legacy completion endpoint for simple text generation</p>
                </div>
            </div>

            <div id="examples" class="section">
                <h2>💡 Code Examples</h2>

                <h3>JavaScript / Node.js</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
const response = await fetch('<span class="worker-url-placeholder">[WORKER_URL]</span>/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_WORKER_API_KEY'
  },
  body: JSON.stringify({
    model: 'gpt-4',
    messages: [
      { 
        role: 'user', 
        content: 'Explain quantum computing' 
      }
    ],
    max_tokens: 500,
    temperature: 0.7
  })
});

const data = await response.json();
console.log(data.choices[0].message.content);
                </div>

                <h3>Python</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
import requests

response = requests.post(
    '<span class="worker-url-placeholder">[WORKER_URL]</span>/v1/chat/completions',
    headers={
        'Content-Type': 'application/json',
        'Authorization': 'Bearer YOUR_WORKER_API_KEY'
    },
    json={
        'model': 'gpt-4',
        'messages': [
            {
                'role': 'user', 
                'content': 'Explain quantum computing'
            }
        ],
        'max_tokens': 500,
        'temperature': 0.7
    }
)

print(response.json()['choices'][0]['message']['content'])
                </div>

                <h3>cURL</h3>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
curl -X POST <span class="worker-url-placeholder">[WORKER_URL]</span>/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_WORKER_API_KEY" \
  -d '{
    "model": "gpt-4",
    "messages": [
      {"role": "user", "content": "Hello!"}
    ],
    "max_tokens": 100
  }'
                </div>
            </div>

            <div id="auth" class="section">
                <h2>🔐 Authentication</h2>
                
                <p>This API uses Bearer token authentication. Include your worker API key in the Authorization header:</p>

                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
Authorization: Bearer YOUR_WORKER_API_KEY
                </div>

                <h3>Setting Up Your Worker API Key</h3>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>Choose a secure API key for your worker (e.g., <code>sk-myworker-abc123...</code>)</li>
                    <li>Store the key securely (never expose in client-side code)</li>
                    <li>Set it in production using <code>wrangler secret put WORKER_API_KEY</code></li>
                    <li>Users will include this key in all API requests to your worker</li>
                </ol>

                <div class="alert error">
                    <strong>⚠️ Security Warning:</strong> Never expose your worker API key in client-side JavaScript or public repositories. Always use environment variables or secure key management systems.
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEndpoint = null;
        let chatHistory = [];
        let availableModels = [];

        // Load available models on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const currentOrigin = location.origin;
                const curlExample = document.getElementById('curl-example');
                if (curlExample) {
                    curlExample.textContent = curlExample.textContent.replace('[WORKER_URL]', currentOrigin);
                }
                document.querySelectorAll('.worker-url-placeholder').forEach(el => {
                    el.textContent = currentOrigin;
                });
                
                // Load models in background (without requiring API key for UI setup)
                await loadAvailableModels();
            } catch (error) {
                console.log('Could not update worker URL or load models:', error);
            }
        });

        async function loadAvailableModels() {
            try {
                // Try to load models without auth first (will fail but we handle gracefully)
                const response = await fetch('/v1/models');
                if (response.status === 401) {
                    // Expected - no auth provided, but endpoint exists
                    console.log('Models endpoint available, auth required');
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    availableModels = data.data || [];
                    updateModelSelectors();
                }
            } catch (error) {
                console.log('Models endpoint not available yet:', error);
            }
        }

        async function loadModelsWithAuth(apiKey) {
            if (!apiKey) return;
            
            try {
                const response = await fetch('/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    availableModels = data.data || [];
                    updateModelSelectors();
                    
                    // Show models info in UI
                    showModelsInfo(data);
                }
            } catch (error) {
                console.log('Error loading models:', error);
            }
        }

        function updateModelSelectors() {
            const selectors = ['chat-model', 'test-model', 'completion-model'];
            
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector && availableModels.length > 0) {
                    // Keep current selection if it exists
                    const currentValue = selector.value;
                    
                    // Clear and populate
                    selector.innerHTML = '';
                    
                    // Add default options first (for compatibility)
                    const defaultOptions = [
                        { id: 'gpt-4', name: 'GPT-4 (Recommended)' },
                        { id: 'gpt-4-turbo', name: 'GPT-4 Turbo' },
                        { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo' },
                        { id: 'gpt-4o', name: 'GPT-4o' },
                        { id: 'gpt-4o-mini', name: 'GPT-4o Mini' }
                    ];
                    
                    defaultOptions.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.id;
                        option.textContent = opt.name;
                        selector.appendChild(option);
                    });
                    
                    // Add separator
                    if (availableModels.length > 5) {
                        const separator = document.createElement('option');
                        separator.disabled = true;
                        separator.textContent = '─────── Available Models ───────';
                        selector.appendChild(separator);
                    }
                    
                    // Add discovered models
                    availableModels.forEach(model => {
                        // Skip if already in defaults
                        if (!defaultOptions.find(opt => opt.id === model.id)) {
                            const option = document.createElement('option');
                            option.value = model.id;
                            option.textContent = `${model.id} ${model.owned_by ? `(${model.owned_by})` : ''}`;
                            if (model.description) {
                                option.title = model.description;
                            }
                            selector.appendChild(option);
                        }
                    });
                    
                    // Restore selection if it exists
                    if (currentValue) {
                        selector.value = currentValue;
                    }
                }
            });
        }

        function showModelsInfo(data) {
            // Add models info to the UI when loaded
            const modelCount = data.data ? data.data.length : 0;
            const coreApiModels = data.data ? data.data.filter(m => m.owned_by === 'cloudflare').length : 0;
            
            // Update connection status area with models info
            const statusArea = document.querySelector('#tester .api-tester:first-child');
            if (statusArea && !document.getElementById('models-info')) {
                const modelsInfo = document.createElement('div');
                modelsInfo.id = 'models-info';
                modelsInfo.innerHTML = `
                    <div class="alert info" style="margin-top: 15px;">
                        <strong>📊 Models Loaded:</strong> ${modelCount} total 
                        ${coreApiModels > 7 ? `(${coreApiModels} from Core API + compatibility layers)` : '(fallback mode)'}
                    </div>
                `;
                statusArea.appendChild(modelsInfo);
            }
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
        }

        function copyToClipboard(button) {
            const codeBlock = button.parentElement;
            const text = codeBlock.innerText.replace('Copy', '').trim();
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }

        async function testConnection() {
            const apiKey = document.getElementById('global-api-key').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            statusIndicator.className = 'status-indicator';
            statusText.textContent = 'Testing...';

            try {
                const response = await fetch('/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                if (response.ok) {
                    statusIndicator.className = 'status-indicator connected';
                    statusText.textContent = 'Connected';
                    
                    // Load models with the valid API key
                    await loadModelsWithAuth(apiKey);
                } else {
                    statusIndicator.className = 'status-indicator disconnected';
                    statusText.textContent = 'Authentication Failed';
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Connection Failed';
            }
        }

        function clearApiKey() {
            document.getElementById('global-api-key').value = '';
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            statusIndicator.className = 'status-indicator disconnected';
            statusText.textContent = 'Not Connected';
            
            // Clear models info
            const modelsInfo = document.getElementById('models-info');
            if (modelsInfo) {
                modelsInfo.remove();
            }
        }

        async function onChatApiKeyChange() {
            const apiKey = document.getElementById('chat-api-key').value;
            if (apiKey && apiKey.length > 10) {
                await loadModelsWithAuth(apiKey);
            }
        }

        function selectEndpoint(endpoint) {
            currentEndpoint = endpoint;
            
            // Update active state
            document.querySelectorAll('.endpoint-card').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            const tester = document.getElementById('endpoint-tester');
            const title = document.getElementById('endpoint-title');
            const form = document.getElementById('endpoint-form');
            
            tester.style.display = 'block';
            
            if (endpoint === 'models') {
                title.textContent = 'Test: GET /v1/models';
                form.innerHTML = `
                    <button class="btn" onclick="testModelsEndpoint()">Get Available Models</button>
                `;
            } else if (endpoint === 'chat') {
                title.textContent = 'Test: POST /v1/chat/completions';
                form.innerHTML = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="test-model">Model:</label>
                            <select id="test-model">
                                <option value="gpt-4">gpt-4</option>
                                <option value="gpt-4-turbo">gpt-4-turbo</option>
                                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="test-max-tokens">Max Tokens:</label>
                            <input type="number" id="test-max-tokens" value="500" min="1" max="4096">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="test-message">Message:</label>
                        <textarea id="test-message" placeholder="Enter your test message...">Hello! Can you help me understand what you can do?</textarea>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="test-stream"> Enable Streaming
                        </label>
                    </div>
                    <button class="btn" onclick="testChatEndpoint()">Send Chat Request</button>
                `;
            } else if (endpoint === 'completions') {
                title.textContent = 'Test: POST /v1/completions';
                form.innerHTML = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="completion-model">Model:</label>
                            <select id="completion-model">
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-4o">GPT-4o</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="completion-max-tokens">Max Tokens:</label>
                            <input type="number" id="completion-max-tokens" value="100" min="1" max="4096">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="completion-prompt">Prompt:</label>
                        <textarea id="completion-prompt" placeholder="Enter your prompt...">Write a short story about</textarea>
                    </div>
                    <button class="btn" onclick="testCompletionEndpoint()">Send Completion Request</button>
                `;
            }
        }

        async function testModelsEndpoint() {
            const apiKey = document.getElementById('global-api-key').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const responseArea = document.getElementById('endpoint-response');
            responseArea.innerHTML = '<div class="alert info">Fetching available models...</div>';

            try {
                const response = await fetch('/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    responseArea.innerHTML = `
                        <div class="alert success">✅ Models fetched successfully!</div>
                        <div class="json-viewer">${JSON.stringify(data, null, 2)}</div>
                    `;
                } else {
                    responseArea.innerHTML = `
                        <div class="alert error">❌ Error: ${data.error?.message || 'Unknown error'}</div>
                        <div class="json-viewer">${JSON.stringify(data, null, 2)}</div>
                    `;
                }
            } catch (error) {
                responseArea.innerHTML = `<div class="alert error">❌ Network error: ${error.message}</div>`;
            }
        }

        async function testChatEndpoint() {
            const apiKey = document.getElementById('global-api-key').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const model = document.getElementById('test-model').value;
            const message = document.getElementById('test-message').value;
            const maxTokens = parseInt(document.getElementById('test-max-tokens').value);
            const stream = document.getElementById('test-stream').checked;

            const responseArea = document.getElementById('endpoint-response');
            responseArea.innerHTML = '<div class="alert info">Sending chat request...</div>';

            try {
                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: message }],
                        max_tokens: maxTokens,
                        stream: stream
                    })
                });

                if (stream) {
                    responseArea.innerHTML = '<div class="alert success">✅ Streaming response:</div><div class="json-viewer" id="stream-output">Connecting...</div>';
                    const streamOutput = document.getElementById('stream-output');
                    
                    if (!response.body) {
                        throw new Error('Streaming not supported by browser');
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';
                    let fullResponse = '';

                    try {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            
                            // Keep the last incomplete line in buffer
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.trim() === '') continue;
                                
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6).trim();
                                    
                                    if (data === '[DONE]') {
                                        streamOutput.textContent = fullResponse || 'Stream completed';
                                        break;
                                    }

                                    try {
                                        const json = JSON.parse(data);
                                        const content = json.choices?.[0]?.delta?.content;
                                        if (content) {
                                            fullResponse += content;
                                            streamOutput.textContent = fullResponse + '▋';
                                        }
                                    } catch (parseError) {
                                        console.log('Parse error for chunk:', data);
                                    }
                                }
                            }
                        }
                    } finally {
                        reader.releaseLock();
                        // Remove cursor
                        streamOutput.textContent = fullResponse || 'No content received';
                    }
                } else {
                    const data = await response.json();
                    
                    if (response.ok) {
                        responseArea.innerHTML = `
                            <div class="alert success">✅ Chat response received!</div>
                            <div class="json-viewer">${JSON.stringify(data, null, 2)}</div>
                        `;
                    } else {
                        responseArea.innerHTML = `
                            <div class="alert error">❌ Error: ${data.error?.message || 'Unknown error'}</div>
                            <div class="json-viewer">${JSON.stringify(data, null, 2)}</div>
                        `;
                    }
                }
            } catch (error) {
                responseArea.innerHTML = `<div class="alert error">❌ Network error: ${error.message}</div>`;
            }
        }

        async function testCompletionEndpoint() {
            const apiKey = document.getElementById('global-api-key').value;
            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            const model = document.getElementById('completion-model').value;
            const prompt = document.getElementById('completion-prompt').value;
            const maxTokens = parseInt(document.getElementById('completion-max-tokens').value);

            const responseArea = document.getElementById('endpoint-response');
            responseArea.innerHTML = '<div class="alert info">Sending completion request...</div>';

            try {
                const response = await fetch('/v1/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        prompt: prompt,
                        max_tokens: maxTokens
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    responseArea.innerHTML = `
                        <div class="alert success">✅ Completion response received!</div>
                        <div class="json-viewer">${JSON.stringify(data, null, 2)}</div>
                    `;
                } else {
                    responseArea.innerHTML = `
                        <div class="alert error">❌ Error: ${data.error?.message || 'Unknown error'}</div>
                        <div class="json-viewer">${JSON.stringify(data, null, 2)}</div>
                    `;
                }
            } catch (error) {
                responseArea.innerHTML = `<div class="alert error">❌ Network error: ${error.message}</div>`;
            }
        }

        async function sendChatMessage() {
            const apiKey = document.getElementById('chat-api-key').value;
            const model = document.getElementById('chat-model').value;
            const message = document.getElementById('chat-input').value.trim();
            const stream = document.getElementById('stream-chat').checked;

            if (!apiKey) {
                alert('Please enter your API key first');
                return;
            }

            if (!message) {
                alert('Please enter a message');
                return;
            }

            const sendBtn = document.getElementById('send-btn');
            const chatMessages = document.getElementById('chat-messages');
            
            // Add user message to chat
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.innerHTML = `<div class="role">You</div><div>${message}</div>`;
            chatMessages.appendChild(userMessage);

            // Clear input
            document.getElementById('chat-input').value = '';

            // Add assistant message placeholder
            const assistantMessage = document.createElement('div');
            assistantMessage.className = 'message assistant';
            assistantMessage.innerHTML = `<div class="role">Assistant</div><div id="assistant-content"><div class="loading"></div>Thinking...</div>`;
            chatMessages.appendChild(assistantMessage);

            chatMessages.scrollTop = chatMessages.scrollHeight;

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<div class="loading"></div>Sending...';

            try {
                // Add to chat history
                chatHistory.push({ role: 'user', content: message });

                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: chatHistory,
                        stream: stream,
                        max_tokens: 1000
                    })
                });

                const assistantContent = document.getElementById('assistant-content');

                if (stream) {
                    assistantContent.textContent = '';
                    let fullResponse = '';
                    
                    if (!response.body) {
                        throw new Error('Streaming not supported');
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';

                    try {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            
                            // Keep the last incomplete line in buffer
                            buffer = lines.pop() || '';

                            for (const line of lines) {
                                if (line.trim() === '') continue;
                                
                                if (line.startsWith('data: ')) {
                                    const data = line.slice(6).trim();
                                    
                                    if (data === '[DONE]') {
                                        chatHistory.push({ role: 'assistant', content: fullResponse });
                                        assistantContent.textContent = fullResponse;
                                        break;
                                    }

                                    try {
                                        const json = JSON.parse(data);
                                        const content = json.choices?.[0]?.delta?.content;
                                        if (content) {
                                            fullResponse += content;
                                            assistantContent.textContent = fullResponse;
                                            chatMessages.scrollTop = chatMessages.scrollHeight;
                                        }
                                    } catch (parseError) {
                                        console.log('Parse error for chat chunk:', data);
                                    }
                                }
                            }
                        }
                    } finally {
                        reader.releaseLock();
                        if (fullResponse) {
                            chatHistory.push({ role: 'assistant', content: fullResponse });
                        }
                    }
                } else {
                    const data = await response.json();
                    
                    if (response.ok) {
                        const responseText = data.choices[0].message.content;
                        assistantContent.textContent = responseText;
                        chatHistory.push({ role: 'assistant', content: responseText });
                    } else {
                        assistantContent.innerHTML = `<span style="color: red;">Error: ${data.error?.message || 'Unknown error'}</span>`;
                    }
                }
            } catch (error) {
                const assistantContent = document.getElementById('assistant-content');
                assistantContent.innerHTML = `<span style="color: red;">Network error: ${error.message}</span>`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Message';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function clearChat() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="message assistant">
                    <div class="role">Assistant</div>
                    <div>Chat cleared! Ready for a new conversation.</div>
                </div>
            `;
            chatHistory = [];
        }
    </script>
</body>
</html>
